<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSER</title>
    <style>
        /* 確保數字調整按鈕始終可見 */
        div[type="number"]::-webkit-inner-spin-button,
        div[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
    <link rel="icon" href="./favicon.ico">
    <link rel="stylesheet" href="./styles/styleAria.css">
    <link rel="stylesheet" href="./styles/headNfooter.css">
    <link rel="stylesheet" href="./styles/sandy_popup.css">
    <!-- 載入React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 載入babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" src="https://aria-hawa.github.io/customizeJersey/jsx/Header.jsx"></script>
    <script type="text/babel" src="https://aria-hawa.github.io/customizeJersey/jsx/Footer.jsx"></script>

</head>

<body>
    <!-- 以下React -->
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        function App() {
            const [buyItems, setBuyItems] = useState([]);
            const [orderTotal, setOrderTotal] = useState(0);
            // 禁用自取
            const [pickUp, setPickUp] = useState(false);

            // 總金額
            useEffect(() => {
                // 一開始抓取localStorage的資訊
                const buyItems = JSON.parse(localStorage.getItem("BuyItems"));
                const mergedItems = buyItems.reduce((acc, current) => {
                    // 查找是否已有相同 name 和 color 的对象
                    const existing = acc.find(item => item.name === current.name && item.color === current.color);

                    if (existing) {
                        // 合并 arrayName、arrayNum、arrayQuantity、arraySize
                        existing.arrayName = [...existing.arrayName, ...current.arrayName];
                        existing.arrayNum = [...existing.arrayNum, ...current.arrayNum];
                        existing.arrayQuantity = [...existing.arrayQuantity, ...current.arrayQuantity];
                        existing.arraySize = [...existing.arraySize, ...current.arraySize];

                        // 更新 total 和 quantity
                        existing.total += current.total;
                        existing.quantity += current.quantity;
                    } else {
                        // 如果没有相同的对象，直接添加
                        acc.push({ ...current });
                    }
                    return acc;
                }, []);


                setBuyItems(mergedItems)
                const Total = mergedItems.map(item => item.total * item.price)
                    .reduce(function (sum, value) {
                        return sum + value; // 累加總價
                    }, 0);
                setOrderTotal(Total+freight)
            }, [])


            // 運費
            const [freight, setFreight] = useState(100)
            // 送貨方式
            let changeFreight = (event) => {
                const selectedMethod = event.target.value;
                if (selectedMethod === "自取") {
                    setFreight(0);
                    setLock(true);
                } else if (selectedMethod === "宅配") {
                    setFreight(100);
                    setLock(false);
                }
            };
            // 送貨地點
            let changePlace = (event) => {
                const selectedPlace = event.target.value;
                if (selectedPlace === "港澳") {
                    setPickUp(true)
                    setFreight(250);
                }
                else if (selectedPlace === "外島") {
                    setPickUp(true)
                    setFreight(200);
                }
                else { setPickUp(false) }
            }
            const AllOrderRef=useRef(null);
            const [orderForm, setOrderForm] = useState(false);
            // 抓取金額框
            const orderDetails = function () {
                // 筆電與桌機不做任何指令,只有手機平板執行
                if (window.innerWidth <= 1024) {
                    setOrderForm(!orderForm);
                    // 抓取最新結果
                    if(!orderForm===true){
                        AllOrderRef.current.style.top = "30vh";
                        AllOrderRef.current.style.padding = "20px 16px";}
                else{AllOrderRef.current.style.top = "94vh";
                AllOrderRef.current.style.padding = "15px 16px";
                }}

            }

            return <>
                <Header />
                <main>
                    <section id="doubleCheck">
                        <div className="pageTitle">
                            <h3>DOUBLE CHECK</h3>
                            <p>請再次確認整筆訂單內容</p>
                        </div>
                        <div id="content">
                            <div id="order" className="inContentDiv">
                                {/* 依照buyItems的陣列數量(lenght)來新增<ContentDiv/> */}
                                {buyItems.map((item, index) =>
                                    <ContentDiv
                                        key={index}
                                        index={index}
                                        buyItems={buyItems.reverse()}

                                    />)}
                                <div class="">
                                    <div className="form">
                                        <article className="personal">
                                            <p>選擇送貨及付款方式</p>
                                            <form action="" method="post" name="paymentForm" id="personalForm" title="送貨及付款方式表單">

                                                <div>
                                                    <label htmlFor="destination">送貨地點</label>
                                                    <select name="destination" id="destination" onClick={changePlace}>
                                                        <option value="台灣">台灣</option>
                                                        <option value="外島">外島</option>
                                                        <option value="港澳">港澳</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label htmlFor="shippingMethod">送貨方式</label>
                                                    <select name="shippingMethod" id="shippingMethod" onClick={changeFreight} disabled={pickUp}>
                                                        <option value="宅配">宅配</option>
                                                        <option value="自取">自取</option>
                                                    </select>
                                                </div>

                                                <div>
                                                    <label for="destination">付款方式</label>
                                                    <select name="" id="">
                                                        <option value="銀行轉帳/ATM">銀行轉帳/ATM</option>
                                                        <option value="貨到付款">貨到付款</option>
                                                        <option value="貨到付款">信用卡刷卡</option>
                                                    </select>
                                                </div>
                                            </form>
                                        </article>
                                    </div>
                                </div>
                            </div>
                            <div id="AllOrder" className="paymentFixed" ref={AllOrderRef} onClick={orderDetails}>
                                <div style={{ padding: "0 0 10px 0 " }} className="paymentTotal">
                                    <img src="./images/icon-amount.svg" alt="" />
                                    <p>訂單明細</p>
                                </div>
                                <div className="contentItem">

                                    {buyItems.map((item, index) =>
                                        <EachOrder
                                            key={index}
                                            index={index}
                                            buyItems={buyItems.reverse()} />)}
                                </div>
                                <hr />
                                <div className="contentTotal">
                                    <p class="contentMoney">運費: {freight}</p>
                                    <p class="itemText">NT${orderTotal}</p>
                                </div>
                            </div>
                        </div>

                        <div className="PDbtn">
                            <a href="./chooseProject.html" class="lastBtn">上一步</a>
                            <a href="./basicInformation.html" class="nextBtn">下一步</a>
                        </div>
                    </section>
                </main>

                <Footer />
            </>
        }
        function DetailsForm(props) {
            const { arrayName, index, arrayNum, arraySize, arrayQuantity } = props
            console.log(typeof arrayName)
            return <>
                <tr class="DetailsForm">
                    <th>{index + 1}</th>
                    <td>{arrayNum[0][index] === "" ? "/" : arrayNum[0][index]}</td>
                    <td>{arrayName[0][index] === "" ? "/" : arrayName[0][index]}</td>
                    <td>{arraySize[0][index]}</td>
                    <td>{arrayQuantity[0][index]}</td>
                </tr>
            </>
        }
        function ContentDiv(props) {
            const { buyItems, key, index, } = props
            // 提取出buyItems的屬性陣列 => map()
            const name = buyItems.map(item => item.name);
            const img = buyItems.map(item => item.img);
            const size = buyItems.map(item => item.size);
            const color = buyItems.map(item => item.color);
            const price = buyItems.map(item => item.price);
            const quantity = buyItems.map(item => item.quantity);
            const total = buyItems.map(item => item.total);
            const arrayName = buyItems.map(item => item.arrayName);
            const arrayNum = buyItems.map(item => item.arrayNum);
            const arrayQuantity = buyItems.map(item => item.arrayQuantity);
            const arraySize = buyItems.map(item => item.arraySize);
            const [windowDetails, setWindowDetails] = useState(false);

            const w_Details = function () {
                setWindowDetails(true);
            }

            const closePopup = function () {
                setWindowDetails(false);
            }
            console.log(arrayName)
            return <>
                <div id="checkOrder" className="orderContent">
                    <div className="tableCaption">
                        <div className="captionLeft">
                            <figure className={`${img[index]}`}></figure>
                            <div className="captionLefText">
                                <p>{name[index]}</p>
                                <p className="unitPrice">單件: NT${price[index]}</p>
                            </div>
                        </div>
                        <div className="captionRightTOP">
                            <p>此款訂購數 : {total[index]}件</p>
                            <span className="arrow" onClick={w_Details}>訂單明細</span>
                        </div>
                    </div>
                    <div className="contentMoney">小計: NT$ <span>{price[index] * total[index]}</span></div>
                </div>
                {windowDetails && (
                    <div id="sizeWindow" class="sizeWindow">
                        <div class="size-content">
                            <div id="tablebox">
                                <p style={{ margin: "0 0 10px 0" }}>您購買的{name[index]}訂單明細如下</p>
                                <table className="size">
                                    <tr className="trSize">
                                        <th className="detailsItem">排序</th>
                                        <td>球號</td>
                                        <td>名字</td>
                                        <td>尺寸</td>
                                        <td>數量</td>

                                    </tr>
                                    {arrayName[index].map((_, index) => (
                                        <DetailsForm
                                            key={index}
                                            arrayName={arrayName}
                                            arrayNum={arrayNum}
                                            arraySize={arraySize}
                                            arrayQuantity={arrayQuantity}
                                            index={index} />
                                    ))}

                                </table>
                            </div>
                            <button id="closePopup" onClick={closePopup}></button>
                        </div>
                    </div>)}
            </>
        }

        function EachOrder(props) {
            const { buyItems, key, index } = props
            const name = buyItems.map(item => item.name);
            const price = buyItems.map(item => item.price);
            const total = buyItems.map(item => item.total);
            return <>
                <div class="eachOrder">
                    <p>{name[index]}</p>
                    <div class="quantity"><p>x </p><p>{total[index]}</p></div>
                </div></>
        }
        ReactDOM
            .createRoot(document.getElementById('root'))
            .render(<App />);
    </script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</body>

</html>